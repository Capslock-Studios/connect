<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse and manage company profiles with WhatsNext Companies">
    <title>WhatsNext Companies</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --light-gray: #ecf0f1;
            --dark-gray: #7f8c8d;
            --border-color: #bdc3c7;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        header {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
        }
        
        .logo-container { 
            display: flex; 
            overflow-x: auto; 
            gap: 15px; 
            padding: 15px 10px; 
            scrollbar-width: thin;
            margin-bottom: 20px;
            position: relative;
        }
        
        .logo-container::after {
            content: 'â†’';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            font-size: 24px;
            opacity: 0.7;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-50%) translateX(5px); }
        }
        
        .logo { 
            width: 80px; 
            height: 80px; 
            cursor: pointer; 
            border-radius: 50%; 
            object-fit: cover;
            border: 2px solid var(--light-gray);
            transition: transform 0.3s, border-color 0.3s;
        }
        
        .logo:hover {
            transform: scale(1.05);
            border-color: var(--secondary-color);
        }
        
        .details, #addCompanyForm { 
            margin-top: 20px; 
            padding: 20px; 
            border: 1px solid var(--border-color); 
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .social-links a { 
            margin-right: 15px;
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .social-links a:hover {
            text-decoration: underline;
        }
        
        .product, .post { 
            border: 1px solid var(--border-color); 
            padding: 15px; 
            margin-top: 10px; 
            border-radius: 5px;
            background-color: white;
        }
        
        .post img {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 3px;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        form label {
            display: block;
            margin-bottom: 15px;
        }
        
        form input, form textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        #logoPreview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-top: 10px;
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .success-message {
            color: #27ae60;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .details, #addCompanyForm {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>WhatsNext Companies</h1>
        <p>Browse and manage company profiles</p>
    </header>

    <main>
        <section aria-labelledby="companies-heading">
            <h2 id="companies-heading">Company Logos</h2>
            <div class="logo-container" id="logoContainer" role="list"></div>
            <button id="addCompanyBtn">Add New Company</button>
        </section>
        
        <section aria-labelledby="company-details-heading">
            <div class="details" id="companyDetails">
                <h2 id="companyName"></h2>
                <p><strong>Category:</strong> <span id="category"></span></p>
                <p><strong>Description:</strong> <span id="description"></span></p>
                <p><strong>Contact:</strong> <a id="email"></a> | <a id="phone"></a></p>
                <p><strong>Location:</strong> <span id="location"></span></p>
                <div class="social-links">
                    <a id="facebook" target="_blank" rel="noopener noreferrer">Facebook</a>
                    <a id="twitter" target="_blank" rel="noopener noreferrer">Twitter</a>
                    <a id="instagram" target="_blank" rel="noopener noreferrer">Instagram</a>
                </div>
            </div>
        </section>

        <section aria-labelledby="posts-heading">
            <h3 id="posts-heading">Recent Posts</h3>
            <div id="posts-container"></div>
            <div id="posts-loading" class="loading" style="display: none;"></div>
        </section>
        
        <section aria-labelledby="products-heading">
            <h3 id="products-heading">Company Products</h3>
            <div id="products-container"></div>
            <div id="products-loading" class="loading" style="display: none;"></div>
        </section>

        <section aria-labelledby="add-company-heading">
            <div id="addCompanyForm">
                <h3 id="add-company-heading">Add New Company</h3>
                <form id="companyForm">
                    <label for="name">Name: 
                        <input type="text" id="name" required>
                        <span id="name-error" class="error-message"></span>
                    </label>
                    
                    <label for="categoryInput">Category: 
                        <input type="text" id="categoryInput" required>
                        <span id="category-error" class="error-message"></span>
                    </label>
                    
                    <label for="descriptionInput">Description: 
                        <textarea id="descriptionInput" required></textarea>
                        <span id="description-error" class="error-message"></span>
                    </label>
                    
                    <label for="emailInput">Email: 
                        <input type="email" id="emailInput" required>
                        <span id="email-error" class="error-message"></span>
                    </label>
                    
                    <label for="phoneInput">Phone: 
                        <input type="tel" id="phoneInput" required>
                        <span id="phone-error" class="error-message"></span>
                    </label>
                    
                    <label for="logoInput">Logo URL: 
                        <input type="url" id="logoInput" required>
                        <span id="logo-error" class="error-message"></span>
                        <img id="logoPreview" alt="Logo preview">
                    </label>
                    
                    <label for="latitudeInput">Latitude: 
                        <input type="text" id="latitudeInput" required>
                        <span id="latitude-error" class="error-message"></span>
                    </label>
                    
                    <label for="longitudeInput">Longitude: 
                        <input type="text" id="longitudeInput" required>
                        <span id="longitude-error" class="error-message"></span>
                    </label>
                    
                    <button type="submit" id="submitBtn">
                        <span id="submitText">Submit</span>
                        <span id="submitSpinner" class="loading" style="display: none;"></span>
                    </button>
                    <span id="form-success" class="success-message"></span>
                </form>
            </div>
        </section>
    </main>

    <script>
        // CSRF Token simulation (in a real app, this would come from your server)
        const csrfToken = 'simulated-csrf-token-' + Math.random().toString(36).substr(2);
        
        // DOM Elements
        const elements = {
            logoContainer: document.getElementById("logoContainer"),
            addCompanyBtn: document.getElementById("addCompanyBtn"),
            companyDetails: document.getElementById("companyDetails"),
            companyName: document.getElementById("companyName"),
            category: document.getElementById("category"),
            description: document.getElementById("description"),
            email: document.getElementById("email"),
            phone: document.getElementById("phone"),
            location: document.getElementById("location"),
            facebook: document.getElementById("facebook"),
            twitter: document.getElementById("twitter"),
            instagram: document.getElementById("instagram"),
            postsContainer: document.getElementById("posts-container"),
            productsContainer: document.getElementById("products-container"),
            addCompanyForm: document.getElementById("addCompanyForm"),
            companyForm: document.getElementById("companyForm"),
            logoInput: document.getElementById("logoInput"),
            logoPreview: document.getElementById("logoPreview"),
            submitBtn: document.getElementById("submitBtn"),
            submitText: document.getElementById("submitText"),
            submitSpinner: document.getElementById("submitSpinner"),
            formSuccess: document.getElementById("form-success")
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', initApp);
        elements.addCompanyBtn.addEventListener('click', toggleAddCompanyForm);
        elements.companyForm.addEventListener('submit', handleFormSubmit);
        elements.logoInput.addEventListener('blur', validateAndPreviewLogo);

        // Initialize the application
        function initApp() {
            fetchCompanies();
            setupErrorHandlers();
        }

        // Setup global error handlers
        function setupErrorHandlers() {
            window.addEventListener('error', handleGlobalError);
            window.addEventListener('unhandledrejection', handlePromiseRejection);
        }

        // Global error handler
        function handleGlobalError(event) {
            console.error('Global error:', event.error);
            alert('An unexpected error occurred. Please try again.');
        }

        // Promise rejection handler
        function handlePromiseRejection(event) {
            console.error('Unhandled promise rejection:', event.reason);
            alert('An operation failed. Please try again.');
        }

        // Toggle add company form visibility
        function toggleAddCompanyForm() {
            elements.addCompanyForm.style.display = elements.addCompanyForm.style.display === 'block' ? 'none' : 'block';
            elements.companyDetails.style.display = 'none';
        }

        // Validate and preview logo
        function validateAndPreviewLogo() {
            const logoUrl = elements.logoInput.value.trim();
            if (!logoUrl) return;

            if (!isValidImageUrl(logoUrl)) {
                showError('logo-error', 'Please enter a valid image URL (JPEG, JPG, GIF, PNG)');
                elements.logoPreview.style.display = 'none';
                return;
            }

            // Test if the image loads
            const img = new Image();
            img.onload = () => {
                elements.logoPreview.src = logoUrl;
                elements.logoPreview.style.display = 'block';
                clearError('logo-error');
            };
            img.onerror = () => {
                showError('logo-error', 'The image could not be loaded. Please check the URL.');
                elements.logoPreview.style.display = 'none';
            };
            img.src = logoUrl;
        }

        // Validate image URL
        function isValidImageUrl(url) {
            return /\.(jpeg|jpg|gif|png|webp)$/i.test(url);
        }

        // Validate phone number
        function isValidPhoneNumber(phone) {
            return /^[+]?[(]?[0-9]{1,4}[)]?[-\s.]?[0-9]{3}[-\s.]?[0-9]{4,6}$/.test(phone);
        }

        // Validate coordinates
        function isValidCoordinate(coord, isLatitude) {
            const num = parseFloat(coord);
            if (isNaN(num)) return false;
            
            if (isLatitude) {
                return num >= -90 && num <= 90;
            } else {
                return num >= -180 && num <= 180;
            }
        }

        // Show error message
        function showError(id, message) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = message;
            }
        }

        // Clear error message
        function clearError(id) {
            showError(id, '');
        }

        // Validate form
        function validateForm(data) {
            let isValid = true;

            // Validate name
            if (!data.name.trim()) {
                showError('name-error', 'Name is required');
                isValid = false;
            } else {
                clearError('name-error');
            }

            // Validate category
            if (!data.category.trim()) {
                showError('category-error', 'Category is required');
                isValid = false;
            } else {
                clearError('category-error');
            }

            // Validate description
            if (!data.description.trim()) {
                showError('description-error', 'Description is required');
                isValid = false;
            } else if (data.description.length < 10) {
                showError('description-error', 'Description should be at least 10 characters');
                isValid = false;
            } else {
                clearError('description-error');
            }

            // Validate email
            if (!data.email.trim()) {
                showError('email-error', 'Email is required');
                isValid = false;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                showError('email-error', 'Please enter a valid email');
                isValid = false;
            } else {
                clearError('email-error');
            }

            // Validate phone
            if (!data.phoneNumber.trim()) {
                showError('phone-error', 'Phone number is required');
                isValid = false;
            } else if (!isValidPhoneNumber(data.phoneNumber)) {
                showError('phone-error', 'Please enter a valid phone number');
                isValid = false;
            } else {
                clearError('phone-error');
            }

            // Validate logo
            if (!data.logo.trim()) {
                showError('logo-error', 'Logo URL is required');
                isValid = false;
            } else if (!isValidImageUrl(data.logo)) {
                showError('logo-error', 'Please enter a valid image URL (JPEG, JPG, GIF, PNG)');
                isValid = false;
            } else {
                clearError('logo-error');
            }

            // Validate coordinates
            if (!isValidCoordinate(data.location.latitude, true)) {
                showError('latitude-error', 'Please enter a valid latitude (-90 to 90)');
                isValid = false;
            } else {
                clearError('latitude-error');
            }

            if (!isValidCoordinate(data.location.longitude, false)) {
                showError('longitude-error', 'Please enter a valid longitude (-180 to 180)');
                isValid = false;
            } else {
                clearError('longitude-error');
            }

            return isValid;
        }

      
        async function handleFormSubmit(event) {
    event.preventDefault();
    
    // Disable button during submission
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    
    try {
        const formData = {
            name: document.getElementById("name").value,
            category: document.getElementById("categoryInput").value,
            description: document.getElementById("descriptionInput").value,
            email: document.getElementById("emailInput").value,
            phoneNumber: document.getElementById("phoneInput").value,
            logo: document.getElementById("logoInput").value,
            location: {
                latitude: parseFloat(document.getElementById("latitudeInput").value),
                longitude: parseFloat(document.getElementById("longitudeInput").value)
            }
        };

        // Basic validation
        if (isNaN(formData.location.latitude) || isNaN(formData.location.longitude)) {
            throw new Error("Invalid coordinates");
        }

        const response = await fetch("https://dbconn-b837.onrender.com/api/companies", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
                // Remove CSRF token if causing CORS issues
                // "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || "Failed to add company");
        }

        const createdCompany = await response.json();
        alert("Company added successfully!");
        addCompanyLogo(createdCompany);
        
    } catch (error) {
        console.error("Submission error:", error);
        alert(`Error: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
    }
}

        // Add company logo to container
        function addCompanyLogo(company) {
            const img = document.createElement("img");
            img.src = company.logo;
            img.className = "logo";
            img.alt = `${company.name} logo`;
            img.setAttribute('role', 'listitem');
            img.onclick = () => displayCompanyDetails(company);
            elements.logoContainer.appendChild(img);
        }

        // Fetch companies
        async function fetchCompanies() {
            try {
                const response = await fetch('https://dbconn-b837.onrender.com/api/companies');
                if (!response.ok) throw new Error("Failed to fetch companies");
                
                const companies = await response.json();
                companies.forEach(addCompanyLogo);
            } catch (error) {
                console.error("Error fetching companies:", error);
                alert("Failed to load companies. Please try again later.");
            }
        }

        // Display company details
        async function displayCompanyDetails(company) {
            try {
                elements.companyName.textContent = company.name;
                elements.category.textContent = company.category;
                elements.description.textContent = company.description;
                
                // Contact info
                elements.email.href = `mailto:${company.email}`;
                elements.email.textContent = company.email;
                elements.phone.href = `tel:${company.phoneNumber}`;
                elements.phone.textContent = company.phoneNumber;
                
                // Social media links
                elements.facebook.href = company.socialMedia?.facebook || '#';
                elements.twitter.href = company.socialMedia?.twitter || '#';
                elements.instagram.href = company.socialMedia?.instagram || '#';
                
                // Location
                try {
                    const locationName = await getLocationName(company.location.latitude, company.location.longitude);
                    elements.location.textContent = locationName;
                } catch (error) {
                    console.error("Error fetching location:", error);
                    elements.location.textContent = `${company.location.latitude}, ${company.location.longitude}`;
                }
                
                // Show details
                elements.companyDetails.style.display = 'block';
                elements.addCompanyForm.style.display = 'none';
                
                // Fetch posts and products
                await Promise.all([
                    fetchPosts(company._id),
                    fetchProducts(company._id)
                ]);
                
            } catch (error) {
                console.error("Error displaying company details:", error);
                alert("Failed to load company details. Please try again.");
            }
        }

        // Fetch posts
        async function fetchPosts(companyId) {
            const loadingElement = document.getElementById("posts-loading");
            loadingElement.style.display = 'block';
            elements.postsContainer.innerHTML = '<p>Loading posts...</p>';
            
            try {
                const response = await fetch(`https://dbconn-b837.onrender.com/api/posts?companyId=${companyId}`);
                if (!response.ok) throw new Error("Failed to fetch posts");
                
                const posts = await response.json();
                elements.postsContainer.innerHTML = '';
                
                if (posts.length === 0) {
                    elements.postsContainer.innerHTML = "<p>No posts available.</p>";
                    return;
                }
                
                posts.forEach(post => {
                    const postElement = document.createElement("div");
                    postElement.classList.add("post");
                    postElement.innerHTML = `
                        <p><strong>${new Date(post.createdAt).toLocaleDateString()}</strong></p>
                        <p>${post.content}</p>
                        ${post.media?.length > 0 ? 
                            `<img src="${post.media[0]}" alt="Post image" loading="lazy">` : 
                            ''}
                    `;
                    elements.postsContainer.appendChild(postElement);
                });
                
            } catch (error) {
                console.error("Error fetching posts:", error);
                elements.postsContainer.innerHTML = '<p>Failed to load posts.</p>';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Fetch products
        async function fetchProducts(companyId) {
            const loadingElement = document.getElementById("products-loading");
            loadingElement.style.display = 'block';
            elements.productsContainer.innerHTML = '<p>Loading products...</p>';
            
            try {
                const response = await fetch(`https://dbconn-b837.onrender.com/api/products?companyId=${companyId}`);
                if (!response.ok) throw new Error("Failed to fetch products");
                
                const products = await response.json();
                elements.productsContainer.innerHTML = '';
                
                if (products.length === 0) {
                    elements.productsContainer.innerHTML = "<p>No products available.</p>";
                    return;
                }
                
                products.forEach(product => {
                    const productElement = document.createElement("div");
                    productElement.classList.add("product");
                    productElement.innerHTML = `
                        <h4>${product.title}</h4>
                        <p>${product.description}</p>
                        ${product.price ? `<p><strong>Price:</strong> $${product.price.toFixed(2)}</p>` : ''}
                    `;
                    elements.productsContainer.appendChild(productElement);
                });
                
            } catch (error) {
                console.error("Error fetching products:", error);
                elements.productsContainer.innerHTML = '<p>Failed to load products.</p>';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        async function getLocationName(lat, lon) {
    // First validate coordinates
    if (typeof lat !== 'number' || typeof lon !== 'number' || isNaN(lat) || isNaN(lon)) {
        console.warn('Invalid coordinates:', lat, lon);
        return 'Location data not available';
    }

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        return data.address?.city || data.address?.town || `Coordinates: ${lat}, ${lon}`;
    } catch (error) {
        console.error("Location API error:", error);
        return `Coordinates: ${lat}, ${lon}`;
    }
}
    </script>
</body>
</html>