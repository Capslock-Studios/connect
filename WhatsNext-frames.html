<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsNext Companies</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .logo-container { display: flex; overflow-x: auto; gap: 10px; padding: 10px; }
        .logo { width: 80px; height: 80px; cursor: pointer; border-radius: 50%; object-fit: cover; }
        .details, #addCompanyForm { margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none; }
        .social-links a { margin-right: 10px; }
        .product, .post { border: 1px solid #ddd; padding: 10px; margin-top: 5px; }
    </style>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --light-gray: #ecf0f1;
            --dark-gray: #7f8c8d;
            --border-color: #bdc3c7;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        header {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
        }
        
        .logo-container { 
            display: flex; 
            overflow-x: auto; 
            gap: 15px; 
            padding: 15px 10px; 
            scrollbar-width: thin;
            margin-bottom: 20px;
            position: relative;
        }
        
        .logo-container::after {
            content: 'â†’';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            font-size: 24px;
            opacity: 0.7;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-50%) translateX(5px); }
        }
        
        .logo { 
            width: 80px; 
            height: 80px; 
            cursor: pointer; 
            border-radius: 50%; 
            object-fit: cover;
            border: 2px solid var(--light-gray);
            transition: transform 0.3s, border-color 0.3s;
        }
        
        .logo:hover {
            transform: scale(1.05);
            border-color: var(--secondary-color);
        }
        
        .details, #addCompanyForm { 
            margin-top: 20px; 
            padding: 20px; 
            border: 1px solid var(--border-color); 
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .social-links a { 
            margin-right: 15px;
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .social-links a:hover {
            text-decoration: underline;
        }
        
        .product, .post { 
            border: 1px solid var(--border-color); 
            padding: 15px; 
            margin-top: 10px; 
            border-radius: 5px;
            background-color: white;
        }
        
        .post img {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 3px;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        form label {
            display: block;
            margin-bottom: 15px;
        }
        
        form input, form textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        #logoPreview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-top: 10px;
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .success-message {
            color: #27ae60;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .details, #addCompanyForm {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <h2>Company Logos</h2>
    <div class="logo-container" id="logoContainer"></div>
    <button id="addCompanyBtn">Add Company</button>
    
    <div class="details" id="companyDetails">
        <h2 id="companyName"></h2>
        <p><strong>Category:</strong> <span id="category"></span></p>
        <p><strong>Description:</strong> <span id="description"></span></p>
        <p><strong>Contact:</strong> <a id="email"></a> | <a id="phone"></a></p>
        <p><strong>Location:</strong> <span id="location"></span></p>
        <div class="social-links">
            <a id="facebook" target="_blank">Facebook</a>
            <a id="twitter" target="_blank">Twitter</a>
            <a id="instagram" target="_blank">Instagram</a>
        </div>
    </div>


    <div id="posts-section">
        <h3>Recent Posts</h3>
        <div id="posts-container"></div>
    </div>
    
    <div id="products-section">
        <h3>Company Products</h3>
        <div id="products-container"></div>
    </div>

    

    <div id="addCompanyForm">
        <h3>Add New Company</h3>
        <form id="companyForm">
            <label>Name: <input type="text" id="name" required></label><br>
            <label>Category: <input type="text" id="categoryInput" required></label><br>
            <label>Description: <textarea id="descriptionInput" required></textarea></label><br>
            <label>Email: <input type="email" id="emailInput" required></label><br>
            <label>Phone: <input type="tel" id="phoneInput" required></label><br>
            <label>Logo URL: <input type="url" id="logoInput" required></label><br>
            <label>Latitude: <input type="text" id="latitudeInput" required></label><br>
            <label>Longitude: <input type="text" id="longitudeInput" required></label><br>
            <button type="submit">Submit</button>
        </form>
    </div>
    
    <script>
        document.getElementById("addCompanyBtn").addEventListener("click", () => {
            document.getElementById("addCompanyForm").style.display = "block";
        });

        document.getElementById("companyForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            const newCompany = {
                name: name.value,
                category: categoryInput.value,
                description: descriptionInput.value,
                email: emailInput.value,
                phoneNumber: phoneInput.value,
                logo: logoInput.value,
                location: {
                    latitude: parseFloat(latitudeInput.value),
                    longitude: parseFloat(longitudeInput.value)
                }
            };

            try {
                let response = await fetch("https://dbconn-b837.onrender.com/api/companies", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newCompany)
                });
                if (!response.ok) throw new Error("Failed to add company");

                let createdCompany = await response.json();
                alert("Company added successfully!");
                companyForm.reset();
                addCompanyForm.style.display = "none";
                addCompanyLogo(createdCompany);
            } catch (error) {
                console.error("Error:", error);
                alert("Error adding company");
            }
        });

        function addCompanyLogo(company) {
            const img = document.createElement("img");
            img.src = company.logo;
            img.className = "logo";
            img.onclick = () => displayCompanyDetails(company);
            logoContainer.appendChild(img);
        }

        
        // Fetch and display posts
async function fetchPosts(companyId) {
    let postsContainer = document.getElementById("posts-container");
    if (!postsContainer) {
        console.error("Error: posts-container element not found.");
        return;
    }

    try {
        let response = await fetch(`https://dbconn-b837.onrender.com/api/posts?companyId=${companyId}`);
        let posts = await response.json();
        postsContainer.innerHTML = ""; // Clear old posts

        if (posts.length === 0) {
            postsContainer.innerHTML = "<p>No posts available.</p>";
            return;
        }

        posts.forEach(post => {
            let postElement = document.createElement("div");
            postElement.classList.add("post");

            postElement.innerHTML = `
                <p><strong>${new Date(post.createdAt).toDateString()}</strong></p>
                <p>${post.content}</p>
                ${post.media.length > 0 ? `<img src="${post.media[0]}" alt="Post image" width="200">` : ""}
            `;

            postsContainer.appendChild(postElement);
        });

    } catch (error) {
        console.error("Error fetching posts:", error);
    }
}

// Fetch and display products
async function fetchProducts(companyId) {
    let productsContainer = document.getElementById("products-container");
    if (!productsContainer) {
        console.error("Error: products-container element not found.");
        return;
    }

    try {
        let response = await fetch(`https://dbconn-b837.onrender.com/api/products?companyId=${companyId}`);
        let products = await response.json();
        productsContainer.innerHTML = ""; // Clear old products

        if (products.length === 0) {
            productsContainer.innerHTML = "<p>No products available.</p>";
            return;
        }

        products.forEach(product => {
            let productElement = document.createElement("div");
            productElement.classList.add("product");

            productElement.innerHTML = `
                <h4>${product.title}</h4>
                <p>${product.description}</p>
            `;

            productsContainer.appendChild(productElement);
        });

    } catch (error) {
        console.error("Error fetching products:", error);
    }
}



        async function fetchCompanies() {
            let response = await fetch('https://dbconn-b837.onrender.com/api/companies');
            let companies = await response.json();
            companies.forEach(addCompanyLogo);
        }

        async function displayCompanyDetails(company) {
            companyName.innerText = company.name;
            category.innerText = company.category;
            description.innerText = company.description;
            email.href = `mailto:${company.email}`;
            email.innerText = company.email;
            phone.href = `tel:${company.phoneNumber}`;
            phone.innerText = company.phoneNumber;
            facebook.href = company.socialMedia?.facebook || '#';
            twitter.href = company.socialMedia?.twitter || '#';
            instagram.href = company.socialMedia?.instagram || '#';
            location.innerText = await getLocationName(company.location.latitude, company.location.longitude);
            companyDetails.style.display = 'block';
            fetchPosts(company._id);
            fetchProducts(company._id);
        }

        async function getLocationName(lat, lon) {
            let response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            let data = await response.json();
            return data.address?.suburb || data.address?.city || 'Unknown';
        }

        fetchCompanies();
    </script>
</body>
</html>
