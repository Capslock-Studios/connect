<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsNext Companies</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .logo-container { display: flex; overflow-x: auto; white-space: nowrap; gap: 10px; padding: 10px; }
        .logo { width: 80px; height: 80px; cursor: pointer; border-radius: 50%; object-fit: cover; }
        .details { margin-top: 20px; padding: 10px; border: 1px solid #ccc; display: none; }
        .social-links a { margin-right: 10px; }
        .product { border: 1px solid #ddd; padding: 10px; margin-top: 5px; }
    </style>
</head>
<body>
    <h2>Company Logos</h2>
    <div class="logo-container" id="logoContainer"></div>
    <button id="addCompanyBtn">Add Company</button>
    
    <div class="details" id="companyDetails">
        <h2 id="companyName"></h2>
        <p><strong>Category:</strong> <span id="category"></span></p>
        <p><strong>Description:</strong> <span id="description"></span></p>
        <p><strong>Contact:</strong> <a id="email"></a> | <a id="phone"></a></p>
        <p><strong>Location:</strong> <span id="location"></span></p>
        <div class="social-links">
            <a id="facebook" target="_blank">Facebook</a>
            <a id="twitter" target="_blank">Twitter</a>
            <a id="instagram" target="_blank">Instagram</a>
        </div>
    </div>

    <div id="posts-section">
        <h3>Recent Posts</h3>
        <div id="posts-container"></div>
    </div>

    <div id="products-section">
        <h3>Company Products</h3>
        <div id="products-container"></div>
    </div>

    <div id="addCompanyForm" style="display: none; margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <h3>Add New Company</h3>
        <form id="companyForm">
            <label>Name: <input type="text" id="name" required></label><br>
            <label>Category: <input type="text" id="categoryInput" required></label><br>
            <label>Description: <textarea id="descriptionInput" required></textarea></label><br>
            <label>Email: <input type="email" id="emailInput" required></label><br>
            <label>Phone: <input type="tel" id="phoneInput" required></label><br>
            <label>Logo URL: <input type="url" id="logoInput" required></label><br>
            <label>Latitude: <input type="text" id="latitudeInput" required></label><br>
            <label>Longitude: <input type="text" id="longitudeInput" required></label><br>
            <button type="submit">Submit</button>
        </form>
    </div>
    
    <script>
        //modal
        document.getElementById("addCompanyBtn").addEventListener("click", function () {
    document.getElementById("addCompanyForm").style.display = "block";
});

// Handle form submission
document.getElementById("companyForm").addEventListener("submit", async function (event) {
    event.preventDefault();

    let newCompany = {
        name: document.getElementById("name").value,
        category: document.getElementById("categoryInput").value,
        description: document.getElementById("descriptionInput").value,
        email: document.getElementById("emailInput").value,
        phoneNumber: document.getElementById("phoneInput").value,
        logo: document.getElementById("logoInput").value,
        location: {
            latitude: parseFloat(document.getElementById("latitudeInput").value),
            longitude: parseFloat(document.getElementById("longitudeInput").value)
        }
    };

    try {
        let response = await fetch("https://dbconn-b837.onrender.com/api/companies", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newCompany)
        });

        if (!response.ok) throw new Error("Failed to add company");

        let createdCompany = await response.json();

        alert("Company added successfully!");
        document.getElementById("companyForm").reset();
        document.getElementById("addCompanyForm").style.display = "none";

        // Add new company logo dynamically
        let logoContainer = document.getElementById("logoContainer");
        let img = document.createElement("img");
        img.src = createdCompany.logo;
        img.className = "logo";
        img.onclick = () => displayCompanyDetails(createdCompany);
        logoContainer.appendChild(img);

    } catch (error) {
        console.error("Error:", error);
        alert("Error adding company");
    }
});
///
        // Fetch and display posts
        async function fetchPosts(companyId) {
            try {
                let response = await fetch(`https://dbconn-b837.onrender.com/api/posts?companyId=${companyId}`);
                let posts = await response.json();

                let postsContainer = document.getElementById("posts-container");
                postsContainer.innerHTML = ""; // Clear old posts

                if (posts.length === 0) {
                    postsContainer.innerHTML = "<p>No posts available.</p>";
                    return;
                }

                posts.forEach(post => {
                    let postElement = document.createElement("div");
                    postElement.classList.add("post");

                    postElement.innerHTML = `
                        <p><strong>${new Date(post.createdAt).toDateString()}</strong></p>
                        <p>${post.content}</p>
                        ${post.media.length > 0 ? `<img src="${post.media[0]}" alt="Post image" width="200">` : ""}
                    `;

                    postsContainer.appendChild(postElement);
                });

            } catch (error) {
                console.error("Error fetching posts:", error);
            }
        }

        // Fetch and display products
        async function fetchProducts(companyId) {
            try {
                let response = await fetch(`https://dbconn-b837.onrender.com/api/products?companyId=${companyId}`);
                let products = await response.json();

                let productsContainer = document.getElementById("products-container");
                productsContainer.innerHTML = ""; // Clear old products

                if (products.length === 0) {
                    productsContainer.innerHTML = "<p>No products available.</p>";
                    return;
                }

                products.forEach(product => {
                    let productElement = document.createElement("div");
                    productElement.classList.add("product");

                    productElement.innerHTML = `
                        <h4>${product.title}</h4>
                        <p>${product.description}</p>
                    `;

                    productsContainer.appendChild(productElement);
                });

            } catch (error) {
                console.error("Error fetching products:", error);
            }
        }

        // Fetch and display companies
        async function fetchCompanies() {
            const response = await fetch('https://dbconn-b837.onrender.com/api/companies');
            const companies = await response.json();
            const logoContainer = document.getElementById('logoContainer');
            
            companies.forEach(company => {
                const img = document.createElement('img');
                img.src = company.logo;
                img.className = 'logo';
                img.onclick = () => displayCompanyDetails(company);
                logoContainer.appendChild(img);
            });
        }

        function displayCompanyDetails(company) {
            document.getElementById('companyName').innerText = company.name;
            document.getElementById('category').innerText = company.category;
            document.getElementById('description').innerText = company.description;
            document.getElementById('email').href = `mailto:${company.email}`;
            document.getElementById('email').innerText = company.email;
            document.getElementById('phone').href = `tel:${company.phoneNumber}`;
            document.getElementById('phone').innerText = company.phoneNumber;
            
            document.getElementById('facebook').href = company.socialMedia?.facebook || '#';
            document.getElementById('twitter').href = company.socialMedia?.twitter || '#';
            document.getElementById('instagram').href = company.socialMedia?.instagram || '#';
            
            getLocationName(company.location.latitude.$numberDouble, company.location.longitude.$numberDouble)
                .then(suburb => document.getElementById('location').innerText = suburb)
                .catch(() => document.getElementById('location').innerText = 'Unknown');
            
            document.getElementById('companyDetails').style.display = 'block';

            // Fetch posts and products for this company
            fetchPosts(company._id);
            fetchProducts(company._id);
        }

        async function getLocationName(lat, lon) {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await response.json();
            return data.address.suburb || data.address.city || 'Unknown';
        }

        fetchCompanies();
    </script>
</body>
</html>
